## 梦幻岛宝珠

首先数据这么大，普通背包肯定是不能做的，观察下样例，注意到这个 $w$ 的值很特殊，于是我们受到启发，可以按照它给的来设计状态。如果直接统计答案，是比较难的，所以我们可以先求一部分，最后再统计出来。

这里设 $f_{i,   j}$ 表示的是空间最大为 $j\times 2^i$ 时的最大答案。

那么容易在同一组内，将 $j$ 作为空间大小做背包，时间是可以接受的。

那么下一步，就是要考虑将各组不同的答案合并起来了。

这里可以容易想到状压，但是对于每一位，直接考虑背包容量的 0,1 是特别特别复杂的设计，肯定是不可行的。所以，注意到 $2^n> \sum_{i=0}^{n-1}2^i$ 。 所以下一步，就是按位统计答案了。

我们考虑下最后答案的状态是多少，容易得到最后的答案为 $f_{\lfloor \log_2(W)\rfloor,1}$ 。

于是统计转移,先不考虑，位移问题，仅考虑从后一位转移到当前位的方法，肯定有

$$\large f_{i,j}=\max{f_{i,j},f_{i,j-a}+f_{i-1,2a}}$$

这里 $a$ 和 $f$ 中的东西是一样的，都是循环物品大小，其中为何 $g$ 是   $2a$  手算一下就知道了。如何考虑 $W$ 中的限制呢？注意到这个数组中，若当前位有1的限制，那么让其偏移量多一即可，所以将上述的方程加一个：

$$\large f_{i,j}=\max{f_{i,j},f_{i,j-a}+f_{i-1,2a+(W>>(i-1) \& 1)}}$$

就可以了。  